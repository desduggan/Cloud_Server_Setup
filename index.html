<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Cloud server setup : A tutorial on how to setup an ubuntu cloud server to serve Django applications with a virtual host. ">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Cloud server setup</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/drduggan/Cloud_Server_Setup">View on GitHub</a>

          <h1 id="project_title">Cloud server setup</h1>
          <h2 id="project_tagline">A tutorial on how to setup an ubuntu cloud server to serve Django applications with a virtual host. </h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/drduggan/Cloud_Server_Setup/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/drduggan/Cloud_Server_Setup/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="building-a-cloud-server-to-run-django-applications" class="anchor" href="#building-a-cloud-server-to-run-django-applications"><span class="octicon octicon-link"></span></a>Building a Cloud Server to run Django Applications</h1>

<p>Author: <a href="http://www.desmondrduggan.com">Desmond Duggan</a>
Feedback Plz: <a href="mailto:desmondrduggan@gmail.com">Email</a></p>

<h2>
<a name="step-1-setup-the-server" class="anchor" href="#step-1-setup-the-server"><span class="octicon octicon-link"></span></a>Step 1. Setup the Server</h2>

<p>The first step to get your Django site up and running is to get a cloud server. I recommend using Digital Ocean, but there are many options including Linode and Amazon AWS. </p>

<p>You only need the basic server, so go with the lowest price solution running an Ubuntu OS. </p>

<p>Test drive your server by logging in as root: </p>

<pre><code>$ ssh root@your.new.ip.address
</code></pre>

<h5>
<a name="user-accounts" class="anchor" href="#user-accounts"><span class="octicon octicon-link"></span></a>User accounts</h5>

<p>It is bad practice to operate your server with the root user, so make your default user account you plan to use. </p>

<p>After you ssh to the server with your root user, execute the following commands to create a new user:</p>

<pre><code>$ sudo adduser bilbo
$ sudo adduser bilbo sudo
</code></pre>

<p>Then you can ssh with that user:</p>

<pre><code>$ ssh bilbo@your.new.up.address
</code></pre>

<h5>
<a name="ssh-keys" class="anchor" href="#ssh-keys"><span class="octicon octicon-link"></span></a>SSH Keys</h5>

<p>Great, now you can login to your server, but each time to ssh, you will be prompted to enter your user password. This is not ideal for two reasons: first, it's annoying; second, it's only as secure as your password is. </p>

<p>To solve both of these problems, you can use highly secure ssh key pairs to authenticate your ssh request. </p>

<p>To do this, ensure that you have a ssh keypair on your home computer by running 1 <code>$ ssh-add -l</code>. </p>

<p>If the output of this command spits out a key identifier and path, then you're good to go. Otherwise, generate a keypair using the following commands:</p>

<pre><code>$ cd ~ # go to the home directory
$ mkdir ~/.ssh # make a hidden folder called ssh
$ chmod 700 ~/.ssh/ # give appropriate permissions so only you have acccess
$ ssh-keygen -t rsa # make your key

$ ssh-add -l ~/.ssh/myKey # tell your system to use this key. Don't give the path to the .pub version. It's likely called id_rsa. 
</code></pre>

<p>Now you have a pair of public and private keys on your machine. The next step is to add your public key to the list of authorized keys in your home directory on the server. We can do this with the following command:</p>

<pre><code>$ ssh-copy-id bilbo@your.ip
</code></pre>

<p>Test it out. <code>ssh bilbo@your.ip</code> You should not be prompted for a password because the server authenticated your identity by verifying your associated ssh key was on the authorized keys list. </p>

<p>To see your authorized key on the server you can check the content of the authorized_keys file in your .ssh directory:</p>

<pre><code>$ cat ~/.ssh/authorized_keys
</code></pre>

<h5>
<a name="github" class="anchor" href="#github"><span class="octicon octicon-link"></span></a>Github</h5>

<p>First, install git</p>

<pre><code>sudo apt-get install git
</code></pre>

<p>Then config with your username and password. These are the names that get associated with your commits. </p>

<pre><code>git config --global user.name "Your Name Here"
git config --global user.email "your_email@example.com"
</code></pre>

<p>If you start using git at this point, every time you try to do a push, pull, clone etc to Github, you will be prompted for your username and password. That's annoying! </p>

<p>To avoid having to do this, we can use the same process we did to authorize your home computer, but this time we will authorize your server with github. </p>

<p>On the server, do the following to generate a ssh keypair. </p>

<pre><code>$ cd ~ # go to the home directory
$ mkdir ~/.ssh # make a hidden folder called ssh
$ chmod 700 ~/.ssh/ # give appropriate permissions so only you have acccess
$ ssh-keygen -t rsa # make your key

$ ssh-add ~/.ssh/myKey # tell your system to use this key. Don't give the path to the .pub version. It's likely called id_rsa. 
</code></pre>

<p>If you run into an error like <code>Could not open a connection to your authentication agent</code>, then add the following command to your <code>~/.profile</code></p>

<pre><code># SSH agent
SSH_ENV=$HOME/.ssh/environment

function start_agent {
     echo "Initialising new SSH agent..."
     /usr/bin/ssh-agent | sed 's/^echo/#echo/' &gt; ${SSH_ENV}
     echo succeeded
     chmod 600 ${SSH_ENV}
     . ${SSH_ENV} &gt; /dev/null
     /usr/bin/ssh-add;
}

# Source SSH settings, if applicable

if [ -f "${SSH_ENV}" ]; then
     . ${SSH_ENV} &gt; /dev/null
     #ps ${SSH_AGENT_PID} doesn't work under cywgin
     ps -ef | grep ${SSH_AGENT_PID} | grep ssh-agent$ &gt; /dev/null || {
        start_agent;
     }
else
     start_agent;
fi
</code></pre>

<blockquote>
<p>credit: <a href="http://www.cygwin.com/ml/cygwin/2001-06/msg00537.html"> Joseph Reagle Jr.</a>   </p>
</blockquote>

<p>This command starts your ssh-agent if it's not running already. </p>

<h5>
<a name="install-and-configure-apache" class="anchor" href="#install-and-configure-apache"><span class="octicon octicon-link"></span></a>Install and configure apache</h5>

<p>If you plan on using apache to serve your projects, it has to be configured and installed. </p>

<pre><code>$ sudo apt-get install apache2 apache2.2-common apache2-mpm-prefork apache2-utils libexpat1
</code></pre>

<p>Then we can install mod_wsgi, which allows you to serve python based applications from Apache. </p>

<pre><code>$ sudo apt-get install libapache2-mod-wsgi
</code></pre>

<p>Then restart apache, and remember this is basically the "reset and get your shit together" command for apache, so you'll use it a lot in the future. </p>

<pre><code>$ sudo service apache2 restart  
</code></pre>

<h5>
<a name="virtualenv" class="anchor" href="#virtualenv"><span class="octicon octicon-link"></span></a>VirtualEnv</h5>

<p>For best practices sake (and to save yourself a huge headache if you need to manage python package dependencies for multiple projects), do yourself a favor and install <a href="http://virtualenvwrapper.readthedocs.org/en/latest/">virtualenv and virtualenvwrapper</a>. This will also be used for the virtualhost to actually serve the Django projects. VirtualEnv makes a seperate changes your python path for a session, so you can have multiple environments on one computer without conflicting versions and dependencies. </p>

<pre><code>$ sudo pip install virtualenv
$ sudo pip install virtualenvwrapper
</code></pre>

<p>Then add the following to your <code>.bashrc</code> or <code>.profile</code>. </p>

<pre><code># virtualenv
export WORKON_HOME=$HOME/.virtualenvs
export PROJECT_HOME=$HOME/Devel
source /usr/local/bin/virtualenvwrapper.sh
</code></pre>

<p>Now you can type </p>

<pre><code>$ workon # list all of your virtual environments. 
$ mkvirtualenv DevelopmentEnv # make a new environment
$ workon DevelopmentEnv # point your python path to this new environment
</code></pre>

<h5>
<a name="install-dependencies" class="anchor" href="#install-dependencies"><span class="octicon octicon-link"></span></a>Install Dependencies</h5>

<p>Go to your project folder</p>

<pre><code>$ cd ~./mysite
</code></pre>

<p>Make sure you have an environment and workon it</p>

<pre><code>$ workon myprojectenv
</code></pre>

<p>Then install your dependencies from your requirements.txt file. If you don't have one, you can make one with <code>$ pip freeze &gt; requirements.txt</code> on your home machine where you did local development. </p>

<pre><code>$ pip install -r requirements.txt 
</code></pre>

<h5>
<a name="mysql" class="anchor" href="#mysql"><span class="octicon octicon-link"></span></a>Mysql</h5>

<p>Lastl, but certainly not least! Install the database.</p>

<pre><code>$ sudo apt-get install mysql-server
$ sudo apt-get install libmysqlclient-dev

$ workon YourEnvironment
$ pip install mysql-python
</code></pre>

<p>Boom! Done. </p>

<hr>

<h2>
<a name="step-2-get-your-project-on-the-server" class="anchor" href="#step-2-get-your-project-on-the-server"><span class="octicon octicon-link"></span></a>Step 2. Get your project on the server</h2>

<p>Once you have a working copy of your project on your local machine, you have to actually get the files up on the server. There are lots of ways to do this, but I recommend one of the following: </p>

<h5>
<a name="github-1" class="anchor" href="#github-1"><span class="octicon octicon-link"></span></a>Github</h5>

<p>In my opinion, the best way to get your project on the server is use Github. This obviously involves setting up the repo, so it is a little more involved, but totally worth it in terms of ROI for the future. </p>

<pre><code>$ git clone git@github.com:BlahBlah
</code></pre>

<h5>
<a name="command-line" class="anchor" href="#command-line"><span class="octicon octicon-link"></span></a>Command Line</h5>

<p>Another option is to use the command line interface for securely transfering files to a remote machine. The following command will copy the folder at /path/to/project to the home directory of 'user' (shortcut is ~) directory on the server. Make sure to include the ~ or another path on the server. </p>

<pre><code>$ scp -r user@your_server_up:~ /local/path/to/project/
</code></pre>

<h5>
<a name="cyber-duck-or-filezilla" class="anchor" href="#cyber-duck-or-filezilla"><span class="octicon octicon-link"></span></a>Cyber Duck or Filezilla</h5>

<p>The other option is to use a program like Cyber Duck or FileZilla to copy files over. Download the client, connect to your server with your ssh key or password, and transfer the files. </p>

<hr>

<h2>
<a name="step-3-prepare-the-project-for-production" class="anchor" href="#step-3-prepare-the-project-for-production"><span class="octicon octicon-link"></span></a>Step 3. Prepare the project for production</h2>

<p>In this step, we make a symbolic link for a folder in /var/www/ to the project in your home directory. This is the location that Apache looks to serve files from. This is a crucial step and it's very important to get all of the permissions and file ownership correct. </p>

<h5>
<a name="symlink-the-project" class="anchor" href="#symlink-the-project"><span class="octicon octicon-link"></span></a>Symlink the project</h5>

<pre><code>$ cd /var/www/
$ sudo mkdir mysite
$  ln -s ~/mysite/* /var/www/mysite # this makes a link between all of the items (*) inside ~/mysite to /var/www/mysite
</code></pre>

<h5>
<a name="ownership" class="anchor" href="#ownership"><span class="octicon octicon-link"></span></a>Ownership</h5>

<p>Here we need to transfer ownership of the files and folders with the Django proejct to root and www-data. Root in the command below designates the user who owns the files and www-data is the group. </p>

<pre><code>$ cd /var/www
$ sudo chown -R root:www-data mysite/
</code></pre>

<h5>
<a name="permissions" class="anchor" href="#permissions"><span class="octicon octicon-link"></span></a>Permissions</h5>

<p>Setup the permissions with 775 like this:</p>

<pre><code>sudo chmod -R 775 mysite/
</code></pre>

<h5>
<a name="setup-the-django-database-interface-mysql" class="anchor" href="#setup-the-django-database-interface-mysql"><span class="octicon octicon-link"></span></a>Setup the Django database interface (MySQL)</h5>

<p>First, in Settings.py you need the databases setting:</p>

<pre><code>DATABASES = {
  'default': {
    'ENGINE':'django.db.backends.mysql',
    'NAME': 'olr',
    'USER': 'olrServer',
    'PASSWORD': 'hnine5tree',
  }
}
</code></pre>

<p>Then, you need to make this user on the MySQL server on your server. Here we login to mysql, create the database for the project, create a user for the project, and give that user permissions. </p>

<pre><code>$ mysql -u root -p

&gt;&gt; create database [db name];
&gt;&gt; CREATE USER 'newuser'@'localhost' IDENTIFIED BY 'password’;
&gt;&gt; GRANT ALL PRIVILEGES ON [db name] . * TO 'newuser'@'localhost’; 
&gt;&gt; -- (* refers to database and and table respectively)
&gt;&gt; FLUSH PRIVILEGES;
</code></pre>

<p>Ensure that any time you modify the permissions for any user, you use the <code>FLUSH PRIVILEGES;</code> command. </p>

<h5>
<a name="static-files" class="anchor" href="#static-files"><span class="octicon octicon-link"></span></a>Static Files</h5>

<p>As we all know, serving static files with Django can be a total pain sometimes. On a server, it is even more painful. We basically have two options here:</p>

<p>One: Host all of your static files on something like Amazon S3 and avoid having them on the server. </p>

<p>Two: Use the <code>python manage.py collectstatic</code> command to put all your static files for your apps in one place.  This is usually mysite/static/. See <a href="https://docs.djangoproject.com/en/1.6/howto/static-files/">here</a> for more info. </p>

<hr>

<h2>
<a name="serving-your-django-projects" class="anchor" href="#serving-your-django-projects"><span class="octicon octicon-link"></span></a>Serving Your Django Projects</h2>

<p>In this step we need to tell Apache to serve the project using a virtualhost and wsgi file. </p>

<h5>
<a name="virtualhost" class="anchor" href="#virtualhost"><span class="octicon octicon-link"></span></a>Virtualhost</h5>

<p>To actually serve the projet, Apache needs to have a virtualhost. First, go to that directory on the filesystem:</p>

<pre><code>$ cd /etc/apache2/sites-available
</code></pre>

<p>Then, make your virtual host:</p>

<pre><code>$ sudo vi mysite.conf
</code></pre>

<p>And make it look like this, but with your correct info: </p>

<pre><code>&lt;VirtualHost *:80&gt;
    ServerAdmin youremail@gmail.com
    ServerName yourdomain.com
    ServerAlias your.ip.address ( or put your full domain here if you have one setup i.e. www.domain.com)
    WSGIScriptAlias / var/www/mysite/index.wsgi

    Alias /static/ /var/www/mysite/static/
    &lt;Location "/static/"&gt;
        Options -Indexes
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>This essentially tells Apache to load the .wsgi file for this domain name for this project. </p>

<h5>
<a name="wsgi-file" class="anchor" href="#wsgi-file"><span class="octicon octicon-link"></span></a>WSGI File</h5>

<p>The final step is to configure this application wsgi file. </p>

<pre><code>import os
import sys
import site

# Add the site-packages of the chosen virtualenv to work with
site.addsitedir('~/.virtualenvs/mysiteEnvironment/local/lib/python2.7/site-packages')

# Add the app's directory to the PYTHONPATH

# first append the project folder path
sys.path.append('/var/www/mysite')

# second append the location of the app settings.py file note the case sensitive path. 
sys.path.append('/var/www/mysite/Mysite')

# Note that Mysite.settings corresponds with the folder name of the settings.py file. 
os.environ['DJANGO_SETTINGS_MODULE'] = 'Mysite.settings'

# Activate your virtual env
activate_env=os.path.expanduser("/home/user/.virtualenvs/mysiteEnv/bin/activate_this.py")
execfile(activate_env, dict(__file__=activate_env))

# django 1.7
from django.core.wsgi import get_wsgi_application
application = get_wsgi_application()

# django 1.6
# import django.core.handlers.wsgi
# application = django.core.handlers.wsgi.WSGIHandler()
</code></pre>

<p>Lastly, enable the virtualhost you created above by typing the following command:</p>

<pre><code>$ sudo a2ensite mysite # this refers to mysite.conf in sites-available
</code></pre>

<p>This will "enable" your virtualhost living in sites-available and bring it into /etc/apache2/sites-enabled. </p>

<p>Then, reload and restart apache</p>

<pre><code>$ sudo service apache2 reload
$ sudo service apache2 restart
</code></pre>

<h2>
<a name="conclusion" class="anchor" href="#conclusion"><span class="octicon octicon-link"></span></a>Conclusion</h2>

<p>To conclude, this is the process I used to get a server up and running to serve my Django apps. Please let me know if I missed something or if you have any questions: <a href="mailto:desmondrduggan@gmail.com">email</a>. </p>

<p>Resources</p>

<ul>
<li><a href="http://stackoverflow.com/questions/20591889/site-does-not-exist-error-for-a2ensite">http://stackoverflow.com/questions/20591889/site-does-not-exist-error-for-a2ensite</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-virtual-hosts-on-ubuntu-14-04-lts">https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-virtual-hosts-on-ubuntu-14-04-lts</a></li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Cloud server setup maintained by <a href="https://github.com/drduggan">drduggan</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-49667232-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
