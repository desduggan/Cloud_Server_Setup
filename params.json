{"name":"Cloud server setup","tagline":"A tutorial on how to setup an ubuntu cloud server to serve Django applications with a virtual host. ","body":"# Building a Cloud Server to run Django Applications\r\n\r\nAuthor: [Desmond Duggan](http://www.desmondrduggan.com)\r\nFeedback Plz: [Email](mailto:desmondrduggan@gmail.com)\r\n\r\n## Step 1. Setup the Server\r\n\r\nThe first step to get your Django site up and running is to get a cloud server. I recommend using Digital Ocean, but there are many options including Linode and Amazon AWS. \r\n\r\nYou only need the basic server, so go with the lowest price solution running an Ubuntu OS. \r\n\r\nTest drive your server by logging in as root: \r\n\r\n\t$ ssh root@your.new.ip.address\r\n\t\r\n##### User accounts\r\n\r\nIt is bad practice to operate your server with the root user, so make your default user account you plan to use. \r\n\r\nAfter you ssh to the server with your root user, execute the following commands to create a new user:\r\n\r\n\t$ sudo adduser bilbo\r\n\t$ sudo adduser bilbo sudo\r\n\t\r\nThen you can ssh with that user:\r\n\r\n\t$ ssh bilbo@your.new.up.address\r\n\t\r\n\r\n##### SSH Keys\r\nGreat, now you can login to your server, but each time to ssh, you will be prompted to enter your user password. This is not ideal for two reasons: first, it's annoying; second, it's only as secure as your password is. \r\n\r\nTo solve both of these problems, you can use highly secure ssh key pairs to authenticate your ssh request. \r\n\r\nTo do this, ensure that you have a ssh keypair on your home computer by running 1 `$ ssh-add -l`. \r\n\r\nIf the output of this command spits out a key identifier and path, then you're good to go. Otherwise, generate a keypair using the following commands:\r\n\r\n\t$ cd ~ # go to the home directory\r\n\t$ mkdir ~/.ssh # make a hidden folder called ssh\r\n\t$ chmod 700 ~/.ssh/ # give appropriate permissions so only you have acccess\r\n\t$ ssh-keygen -t rsa # make your key\r\n\t\r\n\t$ ssh-add -l ~/.ssh/myKey # tell your system to use this key. Don't give the path to the .pub version. It's likely called id_rsa. \r\n\t\r\nNow you have a pair of public and private keys on your machine. The next step is to add your public key to the list of authorized keys in your home directory on the server. We can do this with the following command:\r\n\r\n\t$ ssh-copy-id bilbo@your.ip\r\n\t\r\nTest it out. `ssh bilbo@your.ip` You should not be prompted for a password because the server authenticated your identity by verifying your associated ssh key was on the authorized keys list. \r\n\r\nTo see your authorized key on the server you can check the content of the authorized_keys file in your .ssh directory:\r\n\t\r\n\t$ cat ~/.ssh/authorized_keys\r\n\r\n##### Github\r\nFirst, install git\r\n\r\n\tsudo apt-get install git\r\n\r\nThen config with your username and password. These are the names that get associated with your commits. \r\n\r\n\tgit config --global user.name \"Your Name Here\"\r\n\tgit config --global user.email \"your_email@example.com\"\r\n\t\r\nIf you start using git at this point, every time you try to do a push, pull, clone etc to Github, you will be prompted for your username and password. That's annoying! \r\n\r\nTo avoid having to do this, we can use the same process we did to authorize your home computer, but this time we will authorize your server with github. \r\n\r\nOn the server, do the following to generate a ssh keypair. \r\n\r\n\t$ cd ~ # go to the home directory\r\n\t$ mkdir ~/.ssh # make a hidden folder called ssh\r\n\t$ chmod 700 ~/.ssh/ # give appropriate permissions so only you have acccess\r\n\t$ ssh-keygen -t rsa # make your key\r\n\t\r\n\t$ ssh-add ~/.ssh/myKey # tell your system to use this key. Don't give the path to the .pub version. It's likely called id_rsa. \r\n\t\r\nIf you run into an error like `Could not open a connection to your authentication agent`, then add the following command to your `~/.profile`\r\n\r\n\t# SSH agent\r\n\tSSH_ENV=$HOME/.ssh/environment\r\n\t\r\n\tfunction start_agent {\r\n\t     echo \"Initialising new SSH agent...\"\r\n\t     /usr/bin/ssh-agent | sed 's/^echo/#echo/' > ${SSH_ENV}\r\n\t     echo succeeded\r\n\t     chmod 600 ${SSH_ENV}\r\n\t     . ${SSH_ENV} > /dev/null\r\n\t     /usr/bin/ssh-add;\r\n\t}\r\n\t\r\n\t# Source SSH settings, if applicable\r\n\r\n\tif [ -f \"${SSH_ENV}\" ]; then\r\n\t     . ${SSH_ENV} > /dev/null\r\n\t     #ps ${SSH_AGENT_PID} doesn't work under cywgin\r\n\t     ps -ef | grep ${SSH_AGENT_PID} | grep ssh-agent$ > /dev/null || {\r\n            start_agent;\r\n\t     }\r\n\telse\r\n\t     start_agent;\r\n\tfi\r\n\r\n> credit: [ Joseph Reagle Jr.](http://www.cygwin.com/ml/cygwin/2001-06/msg00537.html) \t\r\n\r\nThis command starts your ssh-agent if it's not running already. \r\n\r\n##### Install and configure apache\r\n\r\nIf you plan on using apache to serve your projects, it has to be configured and installed. \r\n\r\n\t$ sudo apt-get install apache2 apache2.2-common apache2-mpm-prefork apache2-utils libexpat1\r\n\r\nThen we can install mod_wsgi, which allows you to serve python based applications from Apache. \r\n\r\n\t$ sudo apt-get install libapache2-mod-wsgi\r\n\t\r\nThen restart apache, and remember this is basically the \"reset and get your shit together\" command for apache, so you'll use it a lot in the future. \r\n\r\n\t$ sudo service apache2 restart\t\r\n\r\n##### VirtualEnv\r\n\r\nFor best practices sake (and to save yourself a huge headache if you need to manage python package dependencies for multiple projects), do yourself a favor and install [virtualenv and virtualenvwrapper](http://virtualenvwrapper.readthedocs.org/en/latest/). This will also be used for the virtualhost to actually serve the Django projects. VirtualEnv makes a seperate changes your python path for a session, so you can have multiple environments on one computer without conflicting versions and dependencies. \r\n\r\n\t$ sudo pip install virtualenv\r\n\t$ sudo pip install virtualenvwrapper\r\n\r\nThen add the following to your `.bashrc` or `.profile`. \r\n\r\n\t# virtualenv\r\n\texport WORKON_HOME=$HOME/.virtualenvs\r\n\texport PROJECT_HOME=$HOME/Devel\r\n\tsource /usr/local/bin/virtualenvwrapper.sh\r\n\t\r\nNow you can type \r\n\t\r\n\t$ workon # list all of your virtual environments. \r\n\t$ mkvirtualenv DevelopmentEnv # make a new environment\r\n\t$ workon DevelopmentEnv # point your python path to this new environment\r\n\t\r\n##### Install Dependencies\r\n\r\nGo to your project folder\r\n\r\n\t$ cd ~./mysite\r\n\t\r\nMake sure you have an environment and workon it\r\n\t\r\n\t$ workon myprojectenv\r\n\t\r\nThen install your dependencies from your requirements.txt file. If you don't have one, you can make one with `$ pip freeze > requirements.txt` on your home machine where you did local development. \r\n\r\n\t$ pip install -r requirements.txt \r\n\t\r\n\r\n\r\n##### Mysql\r\nLastl, but certainly not least! Install the database.\r\n\r\n\t$ sudo apt-get install mysql-server\r\n\t$ sudo apt-get install libmysqlclient-dev\r\n\t\r\n\t$ workon YourEnvironment\r\n\t$ pip install mysql-python\r\n\t\r\nBoom! Done. \r\n\r\n-----\r\n\r\n## Step 2. Get your project on the server\r\n\r\nOnce you have a working copy of your project on your local machine, you have to actually get the files up on the server. There are lots of ways to do this, but I recommend one of the following: \r\n\r\n##### Github\r\nIn my opinion, the best way to get your project on the server is use Github. This obviously involves setting up the repo, so it is a little more involved, but totally worth it in terms of ROI for the future. \r\n\r\n\t$ git clone git@github.com:BlahBlah\r\n\r\n##### Command Line\r\n\r\nAnother option is to use the command line interface for securely transfering files to a remote machine. The following command will copy the folder at /path/to/project to the home directory of 'user' (shortcut is ~) directory on the server. Make sure to include the ~ or another path on the server. \r\n\r\n\t$ scp -r user@your_server_up:~ /local/path/to/project/\r\n\r\n##### Cyber Duck or Filezilla\r\nThe other option is to use a program like Cyber Duck or FileZilla to copy files over. Download the client, connect to your server with your ssh key or password, and transfer the files. \r\n\r\n-----\r\n\r\n\r\n## Step 3. Prepare the project for production\r\nIn this step, we make a symbolic link for a folder in /var/www/ to the project in your home directory. This is the location that Apache looks to serve files from. This is a crucial step and it's very important to get all of the permissions and file ownership correct. \r\n\r\n##### Symlink the project\r\n\r\n\t$ cd /var/www/\r\n\t$ sudo mkdir mysite\r\n\t$  ln -s ~/mysite/* /var/www/mysite # this makes a link between all of the items (*) inside ~/mysite to /var/www/mysite\r\n\r\n\t\t\r\n##### Ownership\r\nHere we need to transfer ownership of the files and folders with the Django proejct to root and www-data. Root in the command below designates the user who owns the files and www-data is the group. \r\n\r\n\t$ cd /var/www\r\n\t$ sudo chown -R root:www-data mysite/\r\n\t\r\n##### Permissions\r\n\r\nSetup the permissions with 775 like this:\r\n\r\n\tsudo chmod -R 775 mysite/\r\n\r\n##### Setup the Django database interface (MySQL)\r\nFirst, in Settings.py you need the databases setting:\r\n\r\n\tDATABASES = {\r\n\t  'default': {\r\n\t    'ENGINE':'django.db.backends.mysql',\r\n\t    'NAME': 'olr',\r\n\t    'USER': 'olrServer',\r\n\t    'PASSWORD': 'hnine5tree',\r\n\t  }\r\n\t}\r\n\t\r\nThen, you need to make this user on the MySQL server on your server. Here we login to mysql, create the database for the project, create a user for the project, and give that user permissions. \r\n\r\n\t$ mysql -u root -p\r\n\t\r\n\t>> create database [db name];\r\n\t>> CREATE USER 'newuser'@'localhost' IDENTIFIED BY 'password’;\r\n\t>> GRANT ALL PRIVILEGES ON [db name] . * TO 'newuser'@'localhost’; \r\n\t>> -- (* refers to database and and table respectively)\r\n\t>> FLUSH PRIVILEGES;\r\n\t\r\nEnsure that any time you modify the permissions for any user, you use the `FLUSH PRIVILEGES;` command. \r\n\t\r\n##### Static Files\r\nAs we all know, serving static files with Django can be a total pain sometimes. On a server, it is even more painful. We basically have two options here:\r\n\r\nOne: Host all of your static files on something like Amazon S3 and avoid having them on the server. \r\n\r\nTwo: Use the `python manage.py collectstatic` command to put all your static files for your apps in one place.  This is usually mysite/static/. See [here](https://docs.djangoproject.com/en/1.6/howto/static-files/) for more info. \r\n\r\n-----\r\n\r\n## Serving Your Django Projects\r\nIn this step we need to tell Apache to serve the project using a virtualhost and wsgi file. \r\n\r\n##### Virtualhost\r\nTo actually serve the projet, Apache needs to have a virtualhost. First, go to that directory on the filesystem:\r\n\t\r\n\t$ cd /etc/apache2/sites-available\r\n\t\r\nThen, make your virtual host:\r\n\r\n\t$ sudo vi mysite.conf\r\n\t\r\nAnd make it look like this, but with your correct info: \r\n\r\n\t<VirtualHost *:80>\r\n\t\tServerAdmin youremail@gmail.com\r\n\t\tServerName yourdomain.com\r\n\t\tServerAlias your.ip.address ( or put your full domain here if you have one setup i.e. www.domain.com)\r\n\t\tWSGIScriptAlias / var/www/mysite/index.wsgi\r\n\t\r\n\t\tAlias /static/ /var/www/mysite/static/\r\n\t\t<Location \"/static/\">\r\n\t\t\tOptions -Indexes\r\n\t\t</Location>\r\n\t</VirtualHost>\r\n\r\nThis essentially tells Apache to load the .wsgi file for this domain name for this project. \r\n\r\n##### WSGI File\r\n\r\nThe final step is to configure this application wsgi file. \r\n\r\n\timport os\r\n\timport sys\r\n\timport site\r\n\t\r\n\t# Add the site-packages of the chosen virtualenv to work with\r\n\tsite.addsitedir('~/.virtualenvs/mysiteEnvironment/local/lib/python2.7/site-packages')\r\n\t\r\n\t# Add the app's directory to the PYTHONPATH\r\n\r\n\t# first append the project folder path\r\n\tsys.path.append('/var/www/mysite')\r\n\r\n\t# second append the location of the app settings.py file note the case sensitive path. \r\n\tsys.path.append('/var/www/mysite/Mysite')\r\n\t\r\n\t# Note that Mysite.settings corresponds with the folder name of the settings.py file. \r\n\tos.environ['DJANGO_SETTINGS_MODULE'] = 'Mysite.settings'\r\n\t\r\n\t# Activate your virtual env\r\n\tactivate_env=os.path.expanduser(\"/home/user/.virtualenvs/mysiteEnv/bin/activate_this.py\")\r\n\texecfile(activate_env, dict(__file__=activate_env))\r\n\r\n\t# django 1.7\r\n\tfrom django.core.wsgi import get_wsgi_application\r\n\tapplication = get_wsgi_application()\r\n\r\n\t# django 1.6\r\n\t# import django.core.handlers.wsgi\r\n\t# application = django.core.handlers.wsgi.WSGIHandler()\r\n\t\r\n\t\r\n##### \r\n\r\nLastly, enable the virtualhost you created above by typing the following command:\r\n\t\r\n\t$ sudo a2ensite mysite # this refers to mysite.conf in sites-available\r\n\t\r\nThis will \"enable\" your virtualhost living in sites-available and bring it into /etc/apache2/sites-enabled. \r\n\r\nThen, reload and restart apache\r\n\r\n\t$ sudo service apache2 reload\r\n\t$ sudo service apache2 restart\r\n\r\n\r\n## Conclusion\r\n\r\nTo conclude, this is the process I used to get a server up and running to serve my Django apps. Please let me know if I missed something or if you have any questions: [email](mailto:desmondrduggan@gmail.com). \r\n\r\nResources\r\n\r\n- http://stackoverflow.com/questions/20591889/site-does-not-exist-error-for-a2ensite\r\n- https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-virtual-hosts-on-ubuntu-14-04-lts\r\n\t\r\n\r\n","google":"UA-49667232-1","note":"Don't delete this file! It's used internally to help with page regeneration."}